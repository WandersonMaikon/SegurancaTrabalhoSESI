<!DOCTYPE html>
<html lang="pt-BR" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raven - Cadastrar Cliente</title>
    <link rel="icon" href="/images/favicon.png" type="image/png">

    <link rel="stylesheet" href="/vendor/css/simplebar.css">
    <link rel="stylesheet" href="/vendor/css/sweetalert2.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/vendor/css/tom-select.min.css">
</head>

<body
    class="font-theme flex flex-col h-full text-base font-normal bg-zinc-50 dark:bg-zinc-950 text-zinc-600 dark:text-zinc-300">

    <%- include('../partials/sidebar') %>

        <main class="flex-1 lg:ms-64 flex flex-col app-content">
            <%- include('../partials/header') %>

                <div class="px-4 lg:px-10 py-6">
                    <h2 class="text-2xl mb-2">Cadastrar cliente</h2>
                </div>

                <div class="content flex-grow px-4 lg:px-10 pb-10">
                    <form id="formCliente" class="w-full">
                        <div class="grid grid-cols-1 gap-6">
                            <div class="md:col-span-8 space-y-6">

                                <% if (ehAdmin) { %>
                                    <div class="rounded-2xl bg-white dark:bg-zinc-900 shadow-card">
                                        <div class="p-6 border-b border-zinc-500/10 dark:border-zinc-800">
                                            <h5 class="text-xl">Vínculo</h5>
                                        </div>
                                        <div class="p-6">
                                            <label class="mb-2 block">Unidade Responsável <span
                                                    class="text-red-500">*</span></label>
                                            <select name="id_unidade" class="js-select w-full" required>
                                                <option value="">Selecione uma unidade...</option>
                                                <% unidades.forEach(function(unidade) { %>
                                                    <option value="<%= unidade.id_unidade %>">
                                                        <%= unidade.nome_fantasia %>
                                                    </option>
                                                    <% }); %>
                                            </select>
                                        </div>
                                    </div>
                                    <% } %>

                                        <div class="rounded-2xl bg-white dark:bg-zinc-900 shadow-card">
                                            <div class="p-6 border-b border-zinc-500/10 dark:border-zinc-800">
                                                <h5 class="text-xl">Empresa</h5>
                                            </div>
                                            <div class="p-6 grid grid-cols-1 gap-6">

                                                <div class="flex items-end gap-3 w-full max-w-2xl">
                                                    <div class="flex-1 min-w-0">
                                                        <label class="mb-2 block">Nome empresa <span
                                                                class="text-red-500">*</span></label>
                                                        <input name="nome" type="text" class="input h-10 w-full"
                                                            placeholder="Empresa" required>
                                                    </div>
                                                    <label class="inline-flex items-center gap-2 mb-1 cursor-pointer">
                                                        <input type="checkbox" class="input-checkbox"
                                                            id="empresaIndustria" name="empresa_industria" value="1">
                                                        <span>É indústria?</span>
                                                    </label>
                                                </div>

                                                <div id="containerCartao" class="hidden w-full max-w-2xl">
                                                    <label class="mb-2 block text-black-600 font-medium">Desconto Cartão
                                                        Vantagem (%)</label>
                                                    <div class="relative">
                                                        <input id="cartaoVantagem" name="cartao_vantagem" type="number"
                                                            step="0.01" min="0" max="100" class="input h-10 w-full pr-8"
                                                            placeholder="0.00">
                                                        <span
                                                            class="absolute right-3 top-2.5 text-zinc-400 font-bold">%</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="mb-2 block">CNPJ <span
                                                            class="text-red-500">*</span></label>
                                                    <input id="cnpj" name="cnpj" type="text"
                                                        class="input h-10 w-full max-w-2xl"
                                                        placeholder="00.000.000/0000-00" required>
                                                    <p id="feedbackCNPJ" class="text-xs mt-1 hidden"></p>
                                                </div>

                                                <div>
                                                    <label class="mb-2 block">E-mail</label>
                                                    <input name="email" type="email" class="input h-10 w-full max-w-2xl"
                                                        placeholder="email@exemplo.com">
                                                </div>
                                                <div>
                                                    <label class="mb-2 block">Telefone</label>
                                                    <input id="telefone" name="telefone" type="text"
                                                        class="input h-10 w-full max-w-2xl"
                                                        placeholder="(xx) xxxxx-xxxx">
                                                </div>
                                                <div>
                                                    <label class="mb-2 block">Nº de colaboradores</label>
                                                    <input name="ncolaboradores" type="number"
                                                        class="input h-10 w-full max-w-2xl" placeholder="0" min="0">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="rounded-2xl bg-white dark:bg-zinc-900 shadow-card">
                                            <div class="p-6 border-b border-zinc-500/10 dark:border-zinc-800">
                                                <h5 class="text-xl">Sobre o representante</h5>
                                            </div>
                                            <div class="p-6 grid grid-cols-1 gap-6">
                                                <div>
                                                    <label class="mb-2 block">Nome do representante</label>
                                                    <input name="representante_nome" type="text"
                                                        class="input h-10 w-full max-w-2xl" placeholder="Nome completo">
                                                </div>
                                                <div>
                                                    <label class="mb-2 block">CPF/MF</label>
                                                    <input id="cpf" name="cpf" type="text"
                                                        class="input h-10 w-full max-w-2xl"
                                                        placeholder="000.000.000-00">
                                                    <p id="feedbackCPF" class="text-xs mt-1 hidden"></p>
                                                </div>
                                                <div>
                                                    <label class="mb-2 block">RG/CI</label>
                                                    <input name="rg" type="text" class="input h-10 w-full max-w-2xl"
                                                        placeholder="000000">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="rounded-2xl bg-white dark:bg-zinc-900 shadow-card">
                                            <div class="p-6 border-b border-zinc-500/10 dark:border-zinc-800">
                                                <h5 class="text-xl">Endereço</h5>
                                            </div>
                                            <div class="p-6 grid grid-cols-1 gap-6">
                                                <div>
                                                    <label class="mb-2 block">CEP</label>
                                                    <div class="relative w-full max-w-2xl">
                                                        <input id="cep" name="cep" type="text"
                                                            class="input h-10 w-full !pe-11" placeholder="00000-000">
                                                        <button id="btnBuscarCep" type="button"
                                                            class="absolute right-2 top-1/2 -translate-y-1/2 size-8 flex items-center justify-center text-zinc-500 hover:text-primary">
                                                            <span class="icon-[lucide--search] text-lg"></span>
                                                        </button>
                                                    </div>
                                                    <p id="cepMsg" class="text-sm text-zinc-400 mt-2 hidden"></p>
                                                </div>
                                                <div><label class="mb-2 block">País</label><input id="pais" name="pais"
                                                        type="text"
                                                        class="input h-10 w-full max-w-2xl bg-zinc-100 cursor-not-allowed"
                                                        value="Brasil" disabled></div>
                                                <div><label class="mb-2 block">Logradouro</label><input id="logradouro"
                                                        name="endereco" type="text" class="input h-10 w-full max-w-2xl">
                                                </div>
                                                <div><label class="mb-2 block">Número</label><input id="numero"
                                                        name="numero" type="text" class="input h-10 w-full max-w-2xl">
                                                </div>
                                                <div><label class="mb-2 block">Bairro</label><input id="bairro"
                                                        name="bairro" type="text" class="input h-10 w-full max-w-2xl">
                                                </div>
                                                <div><label class="mb-2 block">Cidade</label><input id="cidade"
                                                        name="cidade" type="text" class="input h-10 w-full max-w-2xl">
                                                </div>
                                                <div><label class="mb-2 block">Estado (UF)</label><input id="estado"
                                                        name="estado" type="text" class="input h-10 w-full max-w-2xl">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="flex flex-col sm:flex-row justify-end gap-3 pt-2">
                                            <a href="/clientes"
                                                class="btn border border-red-500 text-red-500 hover:bg-red-500 hover:text-white h-11 px-6 flex items-center justify-center">Cancelar</a>
                                            <button type="submit" id="btnSalvar"
                                                class="btn bg-primary text-white hover:bg-primary-deep h-11 px-6">Salvar</button>
                                        </div>
                            </div>
                        </div>
                    </form>
                </div>

                <%- include('../partials/footer') %>
        </main>

        <script src="/js/theme.js"></script>
        <script src="/vendor/js/tom-select.complete.min.js"></script>
        <script src="/vendor/js/sweetalert2.all.min.js"></script>

        <script>
            // --- ALGORITMOS DE VALIDAÇÃO ---

            function validarCNPJ(cnpj) {
                cnpj = cnpj.replace(/[^\d]+/g, '');
                if (cnpj == '') return false;
                if (cnpj.length != 14) return false;
                // Bloqueia conhecidos (1111..., 2222...)
                if (/^(\d)\1+$/.test(cnpj)) return false;

                let tamanho = cnpj.length - 2
                let numeros = cnpj.substring(0, tamanho);
                let digitos = cnpj.substring(tamanho);
                let soma = 0;
                let pos = tamanho - 7;
                for (let i = tamanho; i >= 1; i--) {
                    soma += numeros.charAt(tamanho - i) * pos--;
                    if (pos < 2) pos = 9;
                }
                let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
                if (resultado != digitos.charAt(0)) return false;

                tamanho = tamanho + 1;
                numeros = cnpj.substring(0, tamanho);
                soma = 0;
                pos = tamanho - 7;
                for (let i = tamanho; i >= 1; i--) {
                    soma += numeros.charAt(tamanho - i) * pos--;
                    if (pos < 2) pos = 9;
                }
                resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
                if (resultado != digitos.charAt(1)) return false;

                return true;
            }

            function validarCPF(cpf) {
                cpf = cpf.replace(/[^\d]+/g, '');
                if (cpf == '') return false;
                if (cpf.length != 11) return false;
                if (/^(\d)\1+$/.test(cpf)) return false;

                let soma = 0;
                let resto;
                for (let i = 1; i <= 9; i++) soma = soma + parseInt(cpf.substring(i - 1, i)) * (11 - i);
                resto = (soma * 10) % 11;

                if ((resto == 10) || (resto == 11)) resto = 0;
                if (resto != parseInt(cpf.substring(9, 10))) return false;

                soma = 0;
                for (let i = 1; i <= 10; i++) soma = soma + parseInt(cpf.substring(i - 1, i)) * (12 - i);
                resto = (soma * 10) % 11;

                if ((resto == 10) || (resto == 11)) resto = 0;
                if (resto != parseInt(cpf.substring(10, 11))) return false;
                return true;
            }

            // --- MANIPULAÇÃO DE MÁSCARAS E EVENTOS ---
            (function () {
                const $ = (id) => document.getElementById(id);
                const onlyDigits = (v) => (v || "").replace(/\D/g, "");

                // Formatadores
                function formatCep(value) {
                    const d = onlyDigits(value).slice(0, 8);
                    return d.length <= 5 ? d : d.slice(0, 5) + "-" + d.slice(5);
                }
                function formatTelefone(value) {
                    const d = onlyDigits(value).slice(0, 11);
                    if (d.length > 10) return `(${d.slice(0, 2)}) ${d.slice(2, 7)}-${d.slice(7)}`;
                    return `(${d.slice(0, 2)}) ${d.slice(2, 6)}-${d.slice(6)}`;
                }
                function formatCpf(value) {
                    const d = onlyDigits(value).slice(0, 11);
                    return d.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
                }

                // Função para Aplicar Máscara
                function applyMask(inputEl, formatter) {
                    if (!inputEl) return;
                    inputEl.addEventListener("input", () => {
                        inputEl.value = formatter(inputEl.value);
                    });
                }

                // Função de Feedback Visual (Cor e Texto)
                function showFeedback(inputId, feedbackId, isValid, msgSuccess, msgError) {
                    const input = $(inputId);
                    const feedback = $(feedbackId);

                    if (!input.value) {
                        feedback.classList.add('hidden');
                        input.classList.remove('border-red-500', 'border-green-500', 'text-red-600', 'text-green-600');
                        return;
                    }

                    feedback.classList.remove('hidden');

                    if (isValid) {
                        feedback.textContent = msgSuccess;
                        feedback.className = "text-xs mt-1 text-green-600 font-medium";
                        input.classList.remove('border-red-500', 'text-red-600');
                        input.classList.add('border-green-500', 'text-green-600');
                    } else {
                        feedback.textContent = msgError;
                        feedback.className = "text-xs mt-1 text-red-500 font-medium";
                        input.classList.remove('border-green-500', 'text-green-600');
                        input.classList.add('border-red-500', 'text-red-600');
                    }
                }

                // --- Lógica do CNPJ ---
                const cnpjInput = $("cnpj");
                if (cnpjInput) {
                    // Máscara
                    cnpjInput.addEventListener('input', function (e) {
                        let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,3})(\d{0,3})(\d{0,4})(\d{0,2})/);
                        e.target.value = !x[2] ? x[1] : x[1] + '.' + x[2] + '.' + x[3] + '/' + x[4] + (x[5] ? '-' + x[5] : '');
                    });

                    // Validação ao sair (Blur)
                    cnpjInput.addEventListener('blur', function () {
                        const valid = validarCNPJ(this.value);
                        showFeedback('cnpj', 'feedbackCNPJ', valid, 'CNPJ Válido', 'CNPJ Inválido');
                    });
                }

                // --- Lógica do CPF ---
                const cpfInput = $("cpf");
                if (cpfInput) {
                    applyMask(cpfInput, formatCpf);

                    // Validação ao sair (Blur)
                    cpfInput.addEventListener('blur', function () {
                        // Se estiver vazio, não valida
                        if (!this.value) return;
                        const valid = validarCPF(this.value);
                        showFeedback('cpf', 'feedbackCPF', valid, 'CPF Válido', 'CPF Inválido');
                    });
                }

                // --- Restante (CEP, Telefone) ---
                applyMask($("cep"), formatCep);
                applyMask($("telefone"), formatTelefone);

                // ... (Lógica do Busca CEP Mantida Igual) ...
                function lockField(id, value) {
                    const el = $(id);
                    if (el && value) {
                        el.value = value;
                        el.readOnly = true;
                        el.classList.add('bg-zinc-100', 'cursor-not-allowed', 'opacity-70');
                    } else if (el) {
                        el.readOnly = false;
                        el.classList.remove('bg-zinc-100', 'cursor-not-allowed', 'opacity-70');
                    }
                }

                async function buscarCep() {
                    const cepInput = $("cep");
                    const btn = $("btnBuscarCep");
                    const msg = $("cepMsg");
                    const cep = onlyDigits(cepInput.value);

                    if (cep.length !== 8) return;

                    btn.disabled = true;
                    msg.textContent = "Buscando...";
                    msg.className = "text-sm mt-2 text-zinc-400 block";

                    try {
                        const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                        const data = await res.json();
                        if (data.erro) throw new Error("CEP não encontrado");

                        lockField("logradouro", data.logradouro);
                        lockField("bairro", data.bairro);
                        lockField("cidade", data.localidade);
                        lockField("estado", data.uf);
                        $("numero").focus();
                        msg.textContent = "Endereço encontrado!";
                        msg.className = "text-sm mt-2 text-green-600 block";
                    } catch (e) {
                        msg.textContent = "CEP não encontrado.";
                        msg.className = "text-sm mt-2 text-red-500 block";
                        lockField("logradouro", "");
                        lockField("bairro", "");
                        lockField("cidade", "");
                        lockField("estado", "");
                    } finally {
                        btn.disabled = false;
                    }
                }
                $("btnBuscarCep")?.addEventListener("click", buscarCep);
                $("cep")?.addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); buscarCep(); } });
            })();

            // --- SUBMIT DO FORM ---
            document.addEventListener('DOMContentLoaded', () => {
                document.querySelectorAll('.js-select').forEach(select => new TomSelect(select, { create: false }));

                // === LÓGICA DO CARTÃO VANTAGEM (NOVO) ===
                const checkIndustria = document.getElementById('empresaIndustria');
                const containerCartao = document.getElementById('containerCartao');
                const inputCartao = document.getElementById('cartaoVantagem');

                // Função para mostrar/esconder
                function toggleCartao() {
                    if (checkIndustria.checked) {
                        containerCartao.classList.remove('hidden');
                    } else {
                        containerCartao.classList.add('hidden');
                        inputCartao.value = ''; // Limpa se desmarcar
                    }
                }

                // Ouve o evento de troca
                checkIndustria.addEventListener('change', toggleCartao);
                // === FIM DA LÓGICA DO CARTÃO VANTAGEM ===

                const form = document.getElementById('formCliente');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // Valida novamente antes de enviar (caso o usuário ignore o aviso vermelho)
                    if (!validarCNPJ(document.getElementById('cnpj').value)) {
                        Swal.fire('Erro', 'Corrija o CNPJ antes de salvar.', 'error');
                        return;
                    }

                    const cpfVal = document.getElementById('cpf').value;
                    if (cpfVal && !validarCPF(cpfVal)) {
                        Swal.fire('Erro', 'Corrija o CPF antes de salvar.', 'error');
                        return;
                    }

                    const btn = document.getElementById('btnSalvar');
                    const originalText = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = 'Salvando...';

                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());

                    data.empresa_industria = document.getElementById('empresaIndustria').checked ? 1 : 0;
                    // O campo cartao_vantagem vai automático pelo FormData se estiver visível/preenchido

                    try {
                        const response = await fetch('/clientes/salvar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        const result = await response.json();

                        if (response.ok && result.success) {
                            Swal.fire('Sucesso!', result.message, 'success').then(() => window.location.href = '/clientes');
                        } else {
                            Swal.fire('Erro', result.message, 'error');
                        }
                    } catch (error) {
                        Swal.fire('Erro', 'Falha na comunicação.', 'error');
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                });
            });
        </script>
</body>

</html>