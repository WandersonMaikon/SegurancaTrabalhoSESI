<!DOCTYPE html>
<html lang="pt-BR" class="h-full">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ProS - Serviços</title>
  <link rel="icon" href="/images/favicon.png" type="image/png">

  <link rel="stylesheet" href="/vendor/css/simplebar.css">
  <link rel="stylesheet" href="/vendor/css/sweetalert2.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com/">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&amp;display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css" />

  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.3/css/dataTables.dataTables.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/select/3.0.1/css/select.dataTables.css">
  <link rel="stylesheet" href="/vendor/css/tom-select.min.css">
</head>

<body
  class="font-theme flex flex-col h-full text-base font-normal bg-zinc-50 dark:bg-zinc-950 text-zinc-600 dark:text-zinc-300">

  <%- include('../partials/sidebar') %>

    <main class="flex-1 lg:ms-64 flex flex-col app-content">
      <%- include('../partials/header') %>

        <div class="px-4 lg:px-8 py-4">
          <h2 class="text-xl mb-2">Serviços</h2>
          <ol class="flex gap-1 items-center text-sm">
            <li class="flex items-center">
              <a href="/dashboard" class="text-zinc-400 hover:text-zinc-700 dark:hover:text-white">Dashboard</a>
            </li>
            <li class="flex items-center opacity-30 leading-none">
              <span class="icon-[lucide--chevron-right] rtl:rotate-180"></span>
            </li>
            <li class="flex items-center"><span class="pointer-events-none">Serviços</span></li>
          </ol>
        </div>

        <div class="content flex-grow lg:px-4">
          <div class="grid grid-cols-1 px-4">
            <div class="rounded-xl bg-white dark:bg-zinc-900 shadow-card mb-4">

              <div class="flex flex-wrap gap-2 items-center p-4 border-b border-zinc-500/10 dark:border-zinc-800">
                <div class="flex-grow">
                  <div class="relative">
                    <input type="search" class="input !ps-9" name="servicoSearch" id="servicoSearch"
                      placeholder="Buscar serviço">
                    <span
                      class="iconify icon-[lucide--search] pointer-events-none absolute start-0 top-0 h-full flex items-center justify-center ms-3 text-muted"></span>
                  </div>
                </div>

                <div class="flex items-center flex-wrap justify-end gap-2">
                  <button id="inativarBtn" class="btn bg-amber-500 text-white hover:bg-amber-600"
                    style="display: none;">
                    Inativar Selecionados
                  </button>

                  <div class="flex-grow w-56 sm:w-auto">
                    <select id="statusFilter" class="js-select w-full sm:w-56">
                      <option value="" >Todos</option>
                      <option value="Ativo" selected>Ativo</option>
                      <option value="Inativo">Inativo</option>
                    </select>
                  </div>

                  <div class="flex items-center gap-2">
                    <a href="/servicos/novo" class="btn bg-primary shrink-0 text-white hover:bg-primary-deep">
                      <span class="icon-[lucide--plus] text-lg me-1"></span>
                      Criar Novo
                    </a>
                  </div>
                </div>
              </div>

              <div class="overflow-x-auto">
                <table id="table_servicos" class="table-default w-full">
                  <thead>
                    <tr>
                      <th></th>
                      <th class="text-nowrap">Nome do serviço</th>
                      <th class="text-nowrap">Unidade</th>
                      <th class="text-nowrap">Status</th>
                      <th class="text-nowrap" data-orderable="false">Ações</th>
                    </tr>
                  </thead>
                  <tbody id="tableBody"></tbody>
                </table>
              </div>

            </div>
          </div>
        </div>

        <%- include('../partials/footer') %>
    </main>

    <div id="dados-servicos-json" style="display: none;">
      <%= servicosJson %>
    </div>

    <script src="/js/theme.js"></script>
    <script src="/vendor/js/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/2.3.3/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/select/3.0.1/js/dataTables.select.js"></script>
    <script src="https://cdn.datatables.net/select/3.0.1/js/select.dataTables.js"></script>
    <script src="/vendor/js/sweetalert2.all.min.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        let listaServicos = [];
        try {
          const divJson = document.getElementById('dados-servicos-json');
          if (divJson && divJson.innerText.trim()) {
            listaServicos = JSON.parse(divJson.innerText);
          }
        } catch (e) { console.error(e); }

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        listaServicos.forEach((s, index) => {
          const tr = document.createElement('tr');
          tr.setAttribute('data-index', index);

          const statusHtml = s.ativo
            ? '<span class="badge bg-green-500/10 text-green-500">Ativo</span>'
            : '<span class="badge bg-zinc-500/10 text-zinc-500">Inativo</span>';

          // Lógica Visual: Se o Admin acessar, ele verá "Global" ou o nome da Unidade.
          // Se o Usuário comum acessar, ele só verá os nomes da unidade dele (o back-end já filtrou o resto).
          const tipoHtml = !s.id_unidade
            ? '<span class="badge bg-purple-500/10 text-purple-500 border border-purple-200">Global</span>'
            : `<span class="badge bg-zinc-100 text-zinc-600 border border-zinc-200">${s.nome_unidade || 'Local'}</span>`;

          tr.innerHTML = `
          <td></td>
          <td class="font-semibold text-zinc-900 whitespace-nowrap dark:text-white">${s.nome_servico}</td>
          <td>${tipoHtml}</td>
          <td>${statusHtml}</td>
          <td>
            <div class="flex items-center gap-1 relative z-[1]">
              <a href="/servicos/editar/${s.id_servico}" class="btn !p-1.5 hover:!text-primary" title="Editar">
                <span class="icon-[lucide--edit] text-lg"></span>
              </a>
            </div>
          </td>
        `;
          tbody.appendChild(tr);
        });

        const table = new DataTable('#table_servicos', {
          lengthChange: false,
          pageLength: 10,
          scrollX: true,
          dom: 'lrtip',
          language: { emptyTable: "Nenhum serviço encontrado", select: { rows: "" } },
          columnDefs: [{ orderable: false, searchable: false, render: DataTable.render.select(), targets: 0 }],
          select: { style: 'os', selector: 'td:first-child', headerCheckbox: false },
          order: [[1, 'asc']],
        });

        document.getElementById('servicoSearch').addEventListener('input', e => { table.search(e.target.value).draw(); });
        document.getElementById('statusFilter').addEventListener('change', function () { table.columns(3).search(this.value).draw(); });

        const inativarBtn = document.getElementById("inativarBtn");
        table.on('select deselect', function () {
          const count = table.rows({ selected: true }).count();
          inativarBtn.style.display = count > 0 ? "inline-flex" : "none";
          inativarBtn.innerText = `Inativar (${count})`;
        });

        inativarBtn.addEventListener('click', () => {
          const selectedRows = table.rows({ selected: true }).nodes();
          const ids = [];
          selectedRows.each(function (row) {
            const index = row.getAttribute('data-index');
            if (listaServicos[index]) ids.push(listaServicos[index].id_servico);
          });
          if (ids.length === 0) return;

          Swal.fire({
            title: 'Inativar?',
            text: "Os serviços selecionados não aparecerão em novas OS.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim, inativar'
          }).then(async (result) => {
            if (result.isConfirmed) {
              const res = await fetch('/servicos/inativar-multiplos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids })
              });
              const data = await res.json();
              if (data.success) location.reload();
            }
          });
        });
      });
    </script>
    <script src="/vendor/js/tom-select.complete.min.js"></script>
    <script>document.querySelectorAll('.js-select').forEach(s => new TomSelect(s, { create: false }));</script>
</body>

</html>