<!DOCTYPE html>
<html lang="pt-BR" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raven - Novo Perfil de Acesso</title>
    <!-- Seus links de CSS aqui... -->
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/vendor/css/sweetalert2.min.css">

    <style>
        /* Seus estilos de checkbox aqui... */
        .checkbox-custom,
        .master-checker {
            appearance: none;
            width: 1.15em;
            height: 1.15em;
            border: 1px solid #e4e4e7;
            border-radius: 0.25rem;
            display: grid;
            place-content: center;
            cursor: pointer;
        }

        .checkbox-custom:checked::before,
        .master-checker:checked::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            box-shadow: inset 1em 1em var(--primary-color, #0AA34A);
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
    </style>
</head>

<body
    class="font-theme flex flex-col h-full text-base font-normal bg-zinc-50 dark:bg-zinc-950 text-zinc-600 dark:text-zinc-300">

    <%- include('../partials/sidebar') %>

        <main class="flex-1 lg:ms-64 flex flex-col app-content">
            <%- include('../partials/header') %>

                <div class="px-4 lg:px-8 py-4">
                    <h2 class="text-xl mb-2 text-zinc-800 dark:text-white font-bold">Novo Perfil de Acesso</h2>
                    <!-- Breadcrumbs... -->
                </div>

                <div class="content flex-grow lg:px-8 px-4 pb-8">
                    <form id="form-novo-perfil">

                        <div class="grid grid-cols-1 gap-6">
                            <!-- Card de Informações Básicas -->
                            <div
                                class="rounded-xl bg-white dark:bg-zinc-900 shadow-card border border-zinc-200 dark:border-zinc-800 p-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-zinc-700 dark:text-zinc-300">Nome do
                                            Perfil</label>
                                        <input type="text" name="nome" id="perfilNome" required
                                            class="w-full rounded-lg border border-zinc-200 bg-transparent px-4 py-2.5 outline-none focus:border-primary"
                                            placeholder="Ex: Supervisor de Vendas">
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-zinc-700 dark:text-zinc-300">Descrição
                                            (Opcional)</label>
                                        <input type="text" name="descricao" id="perfilDescricao"
                                            class="w-full rounded-lg border border-zinc-200 bg-transparent px-4 py-2.5 outline-none"
                                            placeholder="Breve descrição da função">
                                    </div>
                                </div>
                            </div>

                            <!-- Card da Tabela de Permissões -->
                            <div
                                class="rounded-xl bg-white dark:bg-zinc-900 shadow-card border border-zinc-200 dark:border-zinc-800 overflow-hidden">
                                <div class="overflow-x-auto">
                                    <table class="table-default table-hover whitespace-nowrap border-collapse w-full">
                                        <thead>
                                            <tr class="border-b border-zinc-100 dark:border-zinc-800">
                                                <th
                                                    class="py-5 text-xs font-bold text-zinc-500 uppercase tracking-wider pl-8 text-left">
                                                    Módulo</th>
                                                <th
                                                    class="px-4 py-5 text-center text-xs font-bold text-zinc-500 uppercase">
                                                    Ver</th>
                                                <th
                                                    class="px-4 py-5 text-center text-xs font-bold text-zinc-500 uppercase">
                                                    Criar</th>
                                                <th
                                                    class="px-4 py-5 text-center text-xs font-bold text-zinc-500 uppercase">
                                                    Editar</th>
                                                <th
                                                    class="px-4 py-5 text-center text-xs font-bold text-zinc-500 uppercase">
                                                    Inativar</th>
                                                <th
                                                    class="px-4 py-5 text-center text-xs font-bold text-primary uppercase bg-primary/5">
                                                    Tudo</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-zinc-50 dark:divide-zinc-800/50">

                                            <% if (typeof modulos !=='undefined' ) { %>
                                                <% modulos.forEach(function(mod) { %>
                                                    <tr>
                                                        <td class="pl-8 py-4">
                                                            <div
                                                                class="flex items-center gap-3 text-zinc-700 dark:text-zinc-200 font-medium">
                                                                <!-- Ícone genérico ou baseado no nome -->
                                                                <span class="icon-[lucide--box] text-zinc-400"></span>
                                                                <%= mod.nome_modulo %>
                                                            </div>
                                                        </td>
                                                        <!-- Note o name dos inputs: permissoes[ID_MODULO][ACAO] -->
                                                        <td class="px-4 py-4 text-center">
                                                            <input type="checkbox"
                                                                name="permissoes[<%= mod.id_modulo %>][ver]"
                                                                class="checkbox-custom">
                                                        </td>
                                                        <td class="px-4 py-4 text-center">
                                                            <input type="checkbox"
                                                                name="permissoes[<%= mod.id_modulo %>][criar]"
                                                                class="checkbox-custom">
                                                        </td>
                                                        <td class="px-4 py-4 text-center">
                                                            <input type="checkbox"
                                                                name="permissoes[<%= mod.id_modulo %>][editar]"
                                                                class="checkbox-custom">
                                                        </td>
                                                        <td class="px-4 py-4 text-center">
                                                            <input type="checkbox"
                                                                name="permissoes[<%= mod.id_modulo %>][inativar]"
                                                                class="checkbox-custom">
                                                        </td>
                                                        <td class="px-4 py-4 text-center bg-primary/5">
                                                            <input type="checkbox"
                                                                name="permissoes[<%= mod.id_modulo %>][tudo]"
                                                                class="master-checker">
                                                        </td>
                                                    </tr>
                                                    <% }); %>
                                                        <% } %>

                                        </tbody>
                                    </table>
                                </div>

                                <div
                                    class="p-6 border-t border-zinc-100 dark:border-zinc-800 flex justify-end gap-3 bg-zinc-50/50 dark:bg-zinc-900">
                                    <a href="/perfis"
                                        class="btn px-5 py-2 rounded-lg border border-zinc-200 hover:bg-zinc-100 transition-colors text-sm font-medium">Cancelar</a>
                                    <button type="submit"
                                        class="btn px-5 py-2 rounded-lg bg-primary text-white hover:bg-primary-deep transition-colors shadow-lg shadow-primary/20 text-sm font-medium">Salvar
                                        Perfil</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <%- include('../partials/footer') %>
        </main>

        <script src="/js/theme.js"></script>
        <script src="/vendor/js/sweetalert2.all.min.js"></script>

        <script>
            // 1. Lógica do Checkbox "Tudo"
            document.querySelectorAll('.master-checker').forEach(master => {
                master.addEventListener('change', function () {
                    const row = this.closest('tr');
                    const checkboxes = row.querySelectorAll('.checkbox-custom');
                    checkboxes.forEach(cb => cb.checked = this.checked);
                });
            });

            // 2. Envio do Formulário
            document.getElementById('form-novo-perfil').addEventListener('submit', async function (e) {
                e.preventDefault();

                const payload = {
                    nome: document.getElementById('perfilNome').value,
                    descricao: document.getElementById('perfilDescricao').value || '',
                    permissoes: {}
                };

                const rows = document.querySelectorAll('tbody tr');

                rows.forEach(row => {
                    const masterInput = row.querySelector('.master-checker');

                    if (masterInput) {
                        const match = masterInput.name.match(/permissoes\[(.*?)\]/);

                        if (match && match[1]) {
                            const idModulo = match[1];

                            // MUDANÇA AQUI: Retorna 1 se true, 0 se false
                            const isChecked = (tipo) => {
                                const el = row.querySelector(`input[name="permissoes[${idModulo}][${tipo}]"]`);
                                return (el && el.checked) ? 1 : 0;
                            };

                            payload.permissoes[idModulo] = {
                                ver: isChecked('ver'),
                                criar: isChecked('criar'),
                                editar: isChecked('editar'),
                                inativar: isChecked('inativar'),
                                tudo: masterInput.checked ? 1 : 0 // Também converte o master
                            };
                        }
                    }
                });

                console.log("Payload sendo enviado:", payload); // Agora deve aparecer 1 e 0

                try {
                    const response = await fetch('/perfil/novo', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Sucesso!',
                            text: 'Perfil criado com sucesso.',
                            showConfirmButton: false,
                            timer: 1500
                        }).then(() => {
                            window.location.href = '/perfil';
                        });
                    } else {
                        Swal.fire('Erro', result.message || 'Erro ao salvar.', 'error');
                    }

                } catch (error) {
                    console.error("Erro na requisição:", error);
                    Swal.fire('Erro', 'O servidor não respondeu. Verifique o terminal do Node.', 'error');
                }
            });
        </script>
</body>

</html>