<!DOCTYPE html>
<html lang="pt-BR" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Raven - Ordem de serviço</title>
    <link rel="icon" href="/images/favicon.png" type="image/png">

    <!-- Simplebar -->
    <link rel="stylesheet" href="/vendor/css/simplebar.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&amp;display=swap"
        rel="stylesheet">

    <!-- Main Style -->
    <link rel="stylesheet" href="/css/style.css" />

    <!-- Page styles -->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.3.3/css/dataTables.dataTables.css">
    <link rel="stylesheet" href="/vendor/css/tom-select.min.css">
</head>

<body
    class="font-theme flex flex-col h-full text-base font-normal bg-zinc-50 dark:bg-zinc-950 text-zinc-600 dark:text-zinc-300">

    <%- include('partials/sidebar') %>

        <!-- Main -->
        <main class="flex-1 lg:ms-64 flex flex-col app-content">

            <%- include('partials/header') %>

                <!-- Page header -->
                <div class="px-4 lg:px-10 py-6">
                    <h2 class="text-2xl mb-2">Cadastrar ordem de serviço</h2>

                    <ol class="flex gap-1 items-center text-sm">
                        <li class="flex items-center">
                            <a href="/dashboard"
                                class="text-zinc-400 hover:text-zinc-700 dark:hover:text-white">Dashboard</a>
                        </li>
                        <li class="flex items-center opacity-30 leading-none">
                            <span class="icon-[lucide--chevron-right] rtl:rotate-180"></span>
                        </li>
                        <li class="flex items-center">
                            <a href="/ordem-servico"
                                class="text-zinc-400 hover:text-zinc-700 dark:hover:text-white">Ordem de
                                serviço</a>
                        </li>
                        <li class="flex items-center opacity-30 leading-none">
                            <span class="icon-[lucide--chevron-right] rtl:rotate-180"></span>
                        </li>
                        <li class="flex items-center"><span class="pointer-events-none">Cadastrar</span></li>
                    </ol>
                </div>

                <!-- Page content -->
                <div class="content flex-grow px-4 lg:px-10 pb-10">
                    <form action="/ordemservicos/novo" method="post" class="w-full" id="osForm">
                        <div class="grid grid-cols-1 gap-6">
                            <div class="md:col-span-12 space-y-6">

                                <!-- Card: Dados da OS -->
                                <div class="rounded-2xl bg-white dark:bg-zinc-900 shadow-card">
                                    <div class="p-6 border-b border-zinc-500/10 dark:border-zinc-800">
                                        <h5 class="text-xl">Dados da ordem de serviço</h5>
                                    </div>

                                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="mb-2 block">CONTRATO Nº</label>
                                            <input name="contrato_numero" type="text" class="input h-10 w-full"
                                                placeholder="Insira o numero do contrato" required>
                                        </div>

                                        <div>
                                            <label class="mb-2 block">VALOR TOTAL DO CONTRATO</label>
                                            <input name="valor_total_contrato" type="text" class="input h-10 w-full"
                                                placeholder="Insira o valor total do contrato" required>
                                        </div>

                                        <!-- Empresa contratante -->
                                        <div class="md:col-span-2">
                                            <label class="mb-2 block">EMPRESA CONTRATANTE</label>

                                            <div class="relative w-full">
                                                <input type="hidden" name="contratante_id" id="contratante_id" value="">

                                                <input id="contratante_nome" name="contratante_nome" type="text"
                                                    class="input h-10 w-full !pe-11 bg-white dark:bg-zinc-900 cursor-pointer"
                                                    placeholder="Selecione uma empresa..." readonly required
                                                    data-bs-toggle="modal" data-bs-target="#modal_contratante">

                                                <button id="btnBuscarContratante" type="button" data-bs-toggle="modal"
                                                    data-bs-target="#modal_contratante"
                                                    class="absolute right-2 top-1/2 -translate-y-1/2 size-8 rounded-md flex items-center justify-center hover:bg-zinc-100 dark:hover:bg-zinc-800 text-zinc-500 hover:text-zinc-900 dark:hover:text-white"
                                                    title="Buscar empresa" aria-label="Buscar empresa">
                                                    <span class="icon-[lucide--search] text-lg"></span>
                                                </button>
                                            </div>

                                            <p class="text-sm text-zinc-400 mt-2">Clique no campo ou na lupa para
                                                pesquisar a
                                                empresa contratante.</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Card: Escopo -->
                                <div class="rounded-2xl bg-white dark:bg-zinc-900 shadow-card">
                                    <div
                                        class="p-6 border-b border-zinc-500/10 dark:border-zinc-800 flex items-center justify-between gap-3">
                                        <h5 class="text-xl">Escopo</h5>

                                        <button id="btnAddLinha" type="button"
                                            class="btn bg-primary text-white hover:bg-primary-deep h-10 px-4">
                                            <span class="icon-[lucide--plus] text-lg me-1 leading-none"></span>
                                            Adicionar linha
                                        </button>
                                    </div>

                                    <div class="p-6">
                                        <table id="table_escopo" class="table-default whitespace-nowrap w-full">
                                            <thead>
                                                <tr>
                                                    <th class="text-nowrap">
                                                        <div class="flex items-center">Serviços</div>
                                                    </th>
                                                    <th class="text-nowrap">
                                                        <div class="flex items-center">Quantidade</div>
                                                    </th>
                                                    <th class="text-nowrap">
                                                        <div class="flex items-center">Responsável</div>
                                                    </th>
                                                    <th class="text-nowrap" data-orderable="false">
                                                        <div class="flex items-center justify-end">Ações</div>
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>

                                        <p class="text-sm text-zinc-400 mt-3">
                                            Dica: você pode adicionar quantas linhas precisar. Em “Serviços”, clique no
                                            campo ou
                                            na lupa para pesquisar e selecionar. Em “Responsável”, faça o mesmo para
                                            escolher
                                            quem executará.
                                        </p>
                                    </div>
                                </div>

                                <!-- Ações -->
                                <div
                                    class="flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-3 pt-2">
                                    <a href="/ordem-servico"
                                        class="btn border border-red-500 text-red-500 hover:bg-red-500 hover:text-white h-11 px-6 text-center">
                                        <span class="icon-[lucide--x] text-lg me-1 leading-none"></span>
                                        Cancelar
                                    </a>

                                    <button type="submit"
                                        class="btn bg-primary text-white hover:bg-primary-deep h-11 px-6">
                                        <span class="icon-[lucide--save] text-lg me-1 leading-none"></span>
                                        Salvar
                                    </button>
                                </div>

                            </div>
                        </div>
                    </form>
                </div>

                <%- include('partials/footer') %>
        </main>

        <!-- Modal: Empresa Contratante -->
        <div id="modal_contratante" role="dialog" class="modal fade fixed inset-0 z-[70]" tabindex="-1">
            <div class="modal-dialog pointer-events-none w-full h-full flex items-center justify-center p-4">
                <div
                    class="modal-content pointer-events-auto w-full max-w-[40rem] bg-white dark:bg-zinc-900 rounded-xl">
                    <div class="p-4 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between">
                        <h5 class="text-lg">Pesquisar empresa contratante</h5>
                        <button type="button" class="btn !p-2" data-bs-dismiss="modal" aria-label="Fechar">
                            <span class="icon-[lucide--x] text-lg"></span>
                        </button>
                    </div>

                    <div class="p-4">
                        <div class="relative mb-3">
                            <input id="contratanteSearch" type="search" class="input !ps-9 w-full"
                                placeholder="Buscar empresa...">
                            <span
                                class="iconify icon-[lucide--search] pointer-events-none absolute start-0 top-0 h-full flex items-center justify-center ms-3 text-muted"></span>
                        </div>

                        <div class="max-h-[360px] overflow-auto border border-zinc-200 dark:border-zinc-800 rounded-lg">
                            <table class="table-default w-full">
                                <thead>
                                    <tr>
                                        <th>Empresa</th>
                                        <th class="text-right">Selecionar</th>
                                    </tr>
                                </thead>

                                <tbody id="contratanteList">
                                    <tr data-id="1" data-nome="Empresa Exemplo LTDA">
                                        <td class="font-semibold text-zinc-900 dark:text-white">Empresa Exemplo LTDA
                                        </td>
                                        <td class="text-right">
                                            <button type="button"
                                                class="btn bg-primary text-white hover:bg-primary-deep btnPickContratante">
                                                Selecionar
                                            </button>
                                        </td>
                                    </tr>
                                    <tr data-id="2" data-nome="Cliente ABC S/A">
                                        <td class="font-semibold text-zinc-900 dark:text-white">Cliente ABC S/A</td>
                                        <td class="text-right">
                                            <button type="button"
                                                class="btn bg-primary text-white hover:bg-primary-deep btnPickContratante">
                                                Selecionar
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <p class="text-sm text-zinc-400 mt-3">
                            Depois você pode substituir essa lista por dados vindos do banco (EJS/rotas).
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Serviço -->
        <div id="modal_servico" role="dialog" class="modal fade fixed inset-0 z-[70]" tabindex="-1">
            <div class="modal-dialog pointer-events-none w-full h-full flex items-center justify-center p-4">
                <div
                    class="modal-content pointer-events-auto w-full max-w-[40rem] bg-white dark:bg-zinc-900 rounded-xl">
                    <div class="p-4 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between">
                        <h5 class="text-lg">Pesquisar serviço</h5>
                        <button type="button" class="btn !p-2" data-bs-dismiss="modal" aria-label="Fechar">
                            <span class="icon-[lucide--x] text-lg"></span>
                        </button>
                    </div>

                    <div class="p-4">
                        <div class="relative mb-3">
                            <input id="servicoSearch" type="search" class="input !ps-9 w-full"
                                placeholder="Buscar serviço...">
                            <span
                                class="iconify icon-[lucide--search] pointer-events-none absolute start-0 top-0 h-full flex items-center justify-center ms-3 text-muted"></span>
                        </div>

                        <div class="max-h-[420px] overflow-auto border border-zinc-200 dark:border-zinc-800 rounded-lg">
                            <table class="table-default w-full">
                                <thead>
                                    <tr>
                                        <th>Serviço</th>
                                        <th class="text-right">Selecionar</th>
                                    </tr>
                                </thead>

                                <tbody id="servicoList">
                                    <tr data-id="10" data-nome="PGR - PROGRAMA DE GERENCIAMENTO DE RISCOS">
                                        <td class="font-semibold text-zinc-900 dark:text-white">PGR - PROGRAMA DE
                                            GERENCIAMENTO DE RISCOS</td>
                                        <td class="text-right">
                                            <button type="button"
                                                class="btn bg-primary text-white hover:bg-primary-deep btnPickServico">
                                                Selecionar
                                            </button>
                                        </td>
                                    </tr>
                                    <tr data-id="11"
                                        data-nome="PCMSO - PROGRAMA DE CONTROLE MÉDICO DE SAÚDE OCUPACIONAL">
                                        <td class="font-semibold text-zinc-900 dark:text-white">PCMSO - PROGRAMA DE
                                            CONTROLE
                                            MÉDICO DE SAÚDE OCUPACIONAL</td>
                                        <td class="text-right">
                                            <button type="button"
                                                class="btn bg-primary text-white hover:bg-primary-deep btnPickServico">
                                                Selecionar
                                            </button>
                                        </td>
                                    </tr>
                                    <tr data-id="12"
                                        data-nome="LTCAT - LAUDO TÉCNICO DE CONDIÇÕES AMBIENTAIS DO TRABALHO">
                                        <td class="font-semibold text-zinc-900 dark:text-white">LTCAT - LAUDO TÉCNICO DE
                                            CONDIÇÕES AMBIENTAIS DO TRABALHO</td>
                                        <td class="text-right">
                                            <button type="button"
                                                class="btn bg-primary text-white hover:bg-primary-deep btnPickServico">
                                                Selecionar
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <p class="text-sm text-zinc-400 mt-3">
                            Quando clicar em “Selecionar”, o serviço será preenchido na linha ativa do escopo.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Responsável -->
        <div id="modal_responsavel" role="dialog" class="modal fade fixed inset-0 z-[70]" tabindex="-1">
            <div class="modal-dialog pointer-events-none w-full h-full flex items-center justify-center p-4">
                <div
                    class="modal-content pointer-events-auto w-full max-w-[40rem] bg-white dark:bg-zinc-900 rounded-xl">
                    <div class="p-4 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between">
                        <h5 class="text-lg">Pesquisar responsável</h5>
                        <button type="button" class="btn !p-2" data-bs-dismiss="modal" aria-label="Fechar">
                            <span class="icon-[lucide--x] text-lg"></span>
                        </button>
                    </div>

                    <div class="p-4">
                        <div class="relative mb-3">
                            <input id="responsavelSearch" type="search" class="input !ps-9 w-full"
                                placeholder="Buscar responsável...">
                            <span
                                class="iconify icon-[lucide--search] pointer-events-none absolute start-0 top-0 h-full flex items-center justify-center ms-3 text-muted"></span>
                        </div>

                        <div class="max-h-[420px] overflow-auto border border-zinc-200 dark:border-zinc-800 rounded-lg">
                            <table class="table-default w-full">
                                <thead>
                                    <tr>
                                        <th>Responsável</th>
                                        <th class="text-right">Selecionar</th>
                                    </tr>
                                </thead>

                                <tbody id="responsavelList">
                                    <tr data-id="101" data-nome="João Silva">
                                        <td class="font-semibold text-zinc-900 dark:text-white">João Silva</td>
                                        <td class="text-right">
                                            <button type="button"
                                                class="btn bg-primary text-white hover:bg-primary-deep btnPickResponsavel">
                                                Selecionar
                                            </button>
                                        </td>
                                    </tr>
                                    <tr data-id="102" data-nome="Maria Souza">
                                        <td class="font-semibold text-zinc-900 dark:text-white">Maria Souza</td>
                                        <td class="text-right">
                                            <button type="button"
                                                class="btn bg-primary text-white hover:bg-primary-deep btnPickResponsavel">
                                                Selecionar
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <p class="text-sm text-zinc-400 mt-3">
                            Quando clicar em “Selecionar”, o responsável será preenchido na linha ativa do escopo.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script src="/js/theme.js"></script>
        <script src="/vendor/js/jquery.min.js"></script>
        <script src="https://cdn.datatables.net/2.3.3/js/dataTables.js"></script>
        <script src="/vendor/js/tom-select.complete.min.js"></script>

        <script>
            (function () {
                // ==========================================================
                // Pesquisa e seleção de EMPRESA
                // ==========================================================
                const contratanteSearch = document.getElementById('contratanteSearch');
                const contratanteList = document.getElementById('contratanteList');
                const contratanteId = document.getElementById('contratante_id');
                const contratanteNome = document.getElementById('contratante_nome');

                contratanteSearch?.addEventListener('input', () => {
                    const q = (contratanteSearch.value || '').toLowerCase();
                    contratanteList?.querySelectorAll('tr').forEach(tr => {
                        const nome = (tr.getAttribute('data-nome') || '').toLowerCase();
                        tr.style.display = nome.includes(q) ? '' : 'none';
                    });
                });

                contratanteList?.addEventListener('click', (e) => {
                    const btn = e.target.closest('.btnPickContratante');
                    if (!btn) return;

                    const tr = btn.closest('tr');
                    const id = tr?.getAttribute('data-id') || '';
                    const nome = tr?.getAttribute('data-nome') || '';

                    if (contratanteId) contratanteId.value = id;
                    if (contratanteNome) contratanteNome.value = nome;

                    const modalEl = document.getElementById('modal_contratante');
                    if (window.bootstrap && modalEl) {
                        window.bootstrap.Modal.getOrCreateInstance(modalEl).hide();
                    }
                });

                // ==========================================================
                // Modal de serviços + DataTable Escopo
                // ==========================================================
                const servicoSearch = document.getElementById('servicoSearch');
                const servicoList = document.getElementById('servicoList');

                // ==========================================================
                // Modal de responsáveis
                // ==========================================================
                const responsavelSearch = document.getElementById('responsavelSearch');
                const responsavelList = document.getElementById('responsavelList');

                let currentRowIndexServico = null;
                let currentRowIndexResponsavel = null;

                servicoSearch?.addEventListener('input', () => {
                    const q = (servicoSearch.value || '').toLowerCase();
                    servicoList?.querySelectorAll('tr').forEach(tr => {
                        const nome = (tr.getAttribute('data-nome') || '').toLowerCase();
                        tr.style.display = nome.includes(q) ? '' : 'none';
                    });
                });

                responsavelSearch?.addEventListener('input', () => {
                    const q = (responsavelSearch.value || '').toLowerCase();
                    responsavelList?.querySelectorAll('tr').forEach(tr => {
                        const nome = (tr.getAttribute('data-nome') || '').toLowerCase();
                        tr.style.display = nome.includes(q) ? '' : 'none';
                    });
                });

                const dt = new DataTable('#table_escopo', {
                    paging: true,
                    pageLength: 9,
                    lengthChange: false,
                    scrollX: true,
                    dom: 'lrtip',
                    order: [],
                    columnDefs: [{ orderable: false, targets: 3 }],
                });

                let nextIndex = 0;

                function rowHtmlServico(index) {
                    return `
          <div class="flex items-center gap-2">
            <input type="hidden" name="escopo[${index}][servico_id]" value="">
            <input
              type="text"
              name="escopo[${index}][servico_nome]"
              class="input h-10 w-full min-w-[280px] !pe-11 cursor-pointer"
              placeholder="Selecione um serviço..."
              readonly
              required
              data-open-servico="1"
              title="Clique para pesquisar um serviço"
            />
            <button
              type="button"
              class="btn !p-2 js-pick-servico"
              title="Pesquisar serviço"
              aria-label="Pesquisar serviço"
            >
              <span class="icon-[lucide--search] text-lg"></span>
            </button>
          </div>
        `;
                }

                function rowHtmlQtd(index) {
                    return `
          <input
            type="number"
            name="escopo[${index}][quantidade]"
            class="input h-10 w-full min-w-[140px]"
            placeholder="0"
            min="0"
            step="1"
            inputmode="numeric"
            required
          />
        `;
                }

                function rowHtmlResponsavel(index) {
                    return `
          <div class="flex items-center gap-2">
            <input type="hidden" name="escopo[${index}][responsavel_id]" value="">
            <input
              type="text"
              name="escopo[${index}][responsavel_nome]"
              class="input h-10 w-full min-w-[220px] !pe-11 cursor-pointer"
              placeholder="Selecione um responsável..."
              readonly
              required
              data-open-responsavel="1"
              title="Clique para pesquisar um responsável"
            />
            <button
              type="button"
              class="btn !p-2 js-pick-responsavel"
              title="Pesquisar responsável"
              aria-label="Pesquisar responsável"
            >
              <span class="icon-[lucide--search] text-lg"></span>
            </button>
          </div>
        `;
                }

                function rowHtmlAcoes() {
                    return `
          <div class="flex items-center justify-end gap-2">
            <button type="button" class="btn !p-2 js-remove-row" title="Remover linha" aria-label="Remover linha">
              <span class="icon-[lucide--trash] text-lg"></span>
            </button>
          </div>
        `;
                }

                function addRow() {
                    const index = nextIndex;
                    nextIndex++;

                    dt.row.add([
                        rowHtmlServico(index),
                        rowHtmlQtd(index),
                        rowHtmlResponsavel(index),
                        rowHtmlAcoes(),
                    ]).draw(false);

                    const lastRow = dt.row(':last').node();
                    if (lastRow) lastRow.setAttribute('data-row-index', String(index));
                }

                addRow();

                document.getElementById('btnAddLinha')?.addEventListener('click', () => addRow());

                document.getElementById('table_escopo')?.addEventListener('click', (e) => {
                    const pickBtnServico = e.target.closest('.js-pick-servico');
                    const inputServico = e.target.closest('input[data-open-servico="1"]');

                    if (pickBtnServico || inputServico) {
                        const tr = e.target.closest('tr');
                        currentRowIndexServico = tr ? Number(tr.getAttribute('data-row-index')) : null;

                        if (servicoSearch) servicoSearch.value = '';
                        servicoList?.querySelectorAll('tr').forEach(r => r.style.display = '');

                        const modalEl = document.getElementById('modal_servico');
                        if (window.bootstrap && modalEl) {
                            window.bootstrap.Modal.getOrCreateInstance(modalEl).show();
                        }
                        return;
                    }

                    const pickBtnResp = e.target.closest('.js-pick-responsavel');
                    const inputResp = e.target.closest('input[data-open-responsavel="1"]');

                    if (pickBtnResp || inputResp) {
                        const tr = e.target.closest('tr');
                        currentRowIndexResponsavel = tr ? Number(tr.getAttribute('data-row-index')) : null;

                        if (responsavelSearch) responsavelSearch.value = '';
                        responsavelList?.querySelectorAll('tr').forEach(r => r.style.display = '');

                        const modalEl = document.getElementById('modal_responsavel');
                        if (window.bootstrap && modalEl) {
                            window.bootstrap.Modal.getOrCreateInstance(modalEl).show();
                        }
                        return;
                    }

                    const removeBtn = e.target.closest('.js-remove-row');
                    if (removeBtn) {
                        const tr = removeBtn.closest('tr');
                        if (!tr) return;
                        dt.row(tr).remove().draw(false);
                    }
                });

                servicoList?.addEventListener('click', (e) => {
                    const btn = e.target.closest('.btnPickServico');
                    if (!btn) return;

                    const tr = btn.closest('tr');
                    const id = tr?.getAttribute('data-id') || '';
                    const nome = tr?.getAttribute('data-nome') || '';

                    if (currentRowIndexServico === null) return;

                    const idInput = document.querySelector(`input[name="escopo[${currentRowIndexServico}][servico_id]"]`);
                    const nomeInput = document.querySelector(`input[name="escopo[${currentRowIndexServico}][servico_nome]"]`);

                    if (idInput) idInput.value = id;
                    if (nomeInput) nomeInput.value = nome;

                    const modalEl = document.getElementById('modal_servico');
                    if (window.bootstrap && modalEl) {
                        window.bootstrap.Modal.getOrCreateInstance(modalEl).hide();
                    }
                });

                responsavelList?.addEventListener('click', (e) => {
                    const btn = e.target.closest('.btnPickResponsavel');
                    if (!btn) return;

                    const tr = btn.closest('tr');
                    const id = tr?.getAttribute('data-id') || '';
                    const nome = tr?.getAttribute('data-nome') || '';

                    if (currentRowIndexResponsavel === null) return;

                    const idInput = document.querySelector(`input[name="escopo[${currentRowIndexResponsavel}][responsavel_id]"]`);
                    const nomeInput = document.querySelector(`input[name="escopo[${currentRowIndexResponsavel}][responsavel_nome]"]`);

                    if (idInput) idInput.value = id;
                    if (nomeInput) nomeInput.value = nome;

                    const modalEl = document.getElementById('modal_responsavel');
                    if (window.bootstrap && modalEl) {
                        window.bootstrap.Modal.getOrCreateInstance(modalEl).hide();
                    }
                });

                document.getElementById('osForm')?.addEventListener('submit', (e) => {
                    const rowCount = dt.rows().count();
                    if (rowCount < 1) {
                        e.preventDefault();
                        alert('Adicione pelo menos 1 item no escopo.');
                    }
                });
            })();
        </script>
</body>

</html>